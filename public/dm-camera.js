!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).DMCamera={})}(this,(function(e){"use strict";const t=[["트리플","三镜头","三鏡頭","トリプル","สาม","ट्रिपल","ثلاثية","משולשת","үштік","тройная","тройна","потроєна","τριπλή","üçlü","trójobiektywowy","trostruka","trojný","trojitá","trippelt","trippel","triplă","triple","tripla","tiga","kolmois","ba camera"],["듀얼 와이드","雙廣角","双广角","デュアル広角","คู่ด้านหลังมุมกว้าง","ड्युअल वाइड","مزدوجة عريضة","כפולה רחבה","қос кең бұрышты","здвоєна ширококутна","двойная широкоугольная","двойна широкоъгълна","διπλή ευρεία","çift geniş","laajakulmainen kaksois","kép rộng mặt sau","kettős, széles látószögű","grande angular dupla","ganda","dwuobiektywowy","dwikamera","dvostruka široka","duální širokoúhlý","duálna širokouhlá","dupla grande-angular","dublă","dubbel vidvinkel","dual-weitwinkel","dual wide","dual con gran angular","dual","double","doppia con grandangolo","doble","dobbelt vidvinkelkamera"],["camera2 0,"],["후","背面","背置","後面","後置","后面","后置","านหลัง","หลัง","बैक","خلفية","אחורית","задняя","задня","задней","задна","πίσω","zadní","zadná","tylny","trás","trasera","traseira","taka","stražnja","spate","sau","rück","rear","posteriore","posterior","hátsó","darrere","belakang","baksidan","bakre","bak","bagside","back","aртқы","arrière","arka","achterzijde"]],i=e=>e&&"object"==typeof e&&"function"==typeof e.then,s=(async()=>{})().constructor;class a extends s{get status(){return this._s}get isPending(){return"pending"===this._s}get isFulfilled(){return"fulfilled"===this._s}get isRejected(){return"rejected"===this._s}get task(){return this._task}set task(e){let t;this._task=e,i(e)?t=e:"function"==typeof e&&(t=new s(e)),t&&(async()=>{try{const i=await t;e===this._task&&this.resolve(i)}catch(t){e===this._task&&this.reject(t)}})()}get isEmpty(){return null==this._task}constructor(e){let t,s;super(((e,i)=>{t=e,s=i})),this._s="pending",this.resolve=e=>{this.isPending&&(i(e)?this.task=e:(this._s="fulfilled",t(e)))},this.reject=e=>{this.isPending&&(this._s="rejected",s(e))},this.task=e}}const o={width:1280,height:720},r=function(){const e=this,t=MediaDeviceInfo.prototype.toJSON.apply(e);return t.trackLabel=e.trackLabel,t.capabilities=e.capabilities,t};class n{static _cameraNameMatcher=t;static _mapDeviceInfo;_coreWrapper;_video;_wrapperLv1;_wrapperLv2;_regionBoxWrapper;_regionBoxMask;_regionBoxBorder;_uiElement;_objectFit="contain";_pOpen;_shouldClose=!1;_cameraChangedWhenPaused=!1;_resolutionChangedWhenPaused=!1;_requestedCamera="back";_requestedResolution=o;_softZoom={zoom:1,center:{x:0,y:0}};_regionBox={unit:"view-size",center:{x:0,y:0},maskStyle:{background:"rgba(0, 0, 0, 0.5)"},borderStyle:{border:"1px solid #00ff7f"}};_openedListeners=new Set;constructor(){const e=this._coreWrapper=document.createElement("div");Object.assign(e.style,{width:"100%",height:"100%",minWidth:"100px",minHeight:"100px",backgroundColor:"black",display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden",position:"relative"});const t=this._wrapperLv2=document.createElement("div");Object.assign(t.style,{width:"auto",height:"100%",minWidth:"100px",minHeight:"100px",aspectRatio:"1",flex:"none",position:"relative",overflow:"hidden"});const i=this._wrapperLv1=document.createElement("div");Object.assign(i.style,{width:"100%",height:"100%",position:"relative",transformOrigin:"center"});const s=this._video=document.createElement("video");Object.assign(s.style,{width:"100%",height:"100%",position:"absolute",left:"0",top:"0",objectFit:"fill"}),s.muted=!0,s.playsInline=!0,i.append(s),t.append(i),e.append(t);new ResizeObserver((()=>{this._updateObjectFit()})).observe(e)}_updateObjectFit(){if("opened"!==this.status&&"paused"!==this.status)return;const e=this._video,t=this._wrapperLv2.style,i=this._regionBoxWrapper?.style;if("fill"===this._objectFit)return"100%"!==t.width&&(t.width="100%"),"100%"!==t.height&&(t.height="100%"),void(i&&("100%"!==i.width&&(i.width="100%"),"100%"!==i.height&&(i.height="100%")));const{width:s,height:a}=this._coreWrapper.getBoundingClientRect(),o=`${e.videoWidth} / ${e.videoHeight}`;o!=t.aspectRatio&&(t.aspectRatio=o),i&&o!=i.aspectRatio&&(i.aspectRatio=o);let r=!1;s/a>e.videoWidth/e.videoHeight&&(r=!r),"cover"===this._objectFit&&(r=!r),r?("auto"!=t.width&&(t.width="auto"),"100%"!=t.height&&(t.height="100%"),i&&("auto"!=i.width&&(i.width="auto"),"100%"!=i.height&&(i.height="100%"))):("100%"!=t.width&&(t.width="100%"),"auto"!=t.height&&(t.height="auto"),i&&("100%"!=i.width&&(i.width="100%"),"auto"!=i.height&&(i.height="auto")))}get video(){return this._video}get track(){return this._video?.srcObject?.getTracks()[0]}get objectFit(){return this._objectFit}set objectFit(e){this._objectFit=e,this._updateObjectFit()}get status(){return this._pOpen?this._pOpen.isPending?this._shouldClose?"closing":"opening":this._video.paused?"paused":"opened":"closed"}get requestedCamera(){return this._requestedCamera}get requestedResolution(){return this._requestedResolution}get currentCamera(){if("opened"!==this.status)throw Error("Camera is not opened");return n._mapDeviceInfo?.[this.track?.getSettings()?.deviceId]}get currentResolution(){if("opened"!==this.status)throw Error("Camera is not opened");let e=this.track?.getSettings();return[e.width,e.height]}get softZoom(){return this._softZoom}get regionBox(){return this._regionBox}onOpened;enableTouchFocus=!0;enableGestureZoom=!0;enableWheelZoom=!0;enableAutoTorch=!0;static async hasCamera(){return!!(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)).length}static async hasMacroCamera(){return!!(await n.getDeviceInfos()).find((e=>e.capabilities?.facingMode?.includes("environment")&&e.capabilities?.focusDistance?.min<.061))}static async getDeviceInfos(){let e=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));if(!e.length)return[];if(e.some((e=>!e.deviceId))){let t;try{t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),e=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),e.some((e=>!e.deviceId))&&console.warn("Some camera does not have deviceId.")}catch(e){console.warn("Failed to get device ID by opening camera.",e)}if(t){const i=t.getTracks().filter((e=>"video"===e.kind))[0],s=i.getSettings().deviceId;let a=e.find((e=>e.deviceId===s));a?(a.trackLabel=i.label,a.capabilities=i.getCapabilities?.(),a.toJSON=r):console.warn("Can't find current device by `track.getSettings().deviceId`."),t.getTracks().forEach((e=>e.stop()))}}await n._setCapabilities(e);const t=e.reduce(((e,t)=>(e[t.deviceId]=t,e)),{});return n._mapDeviceInfo=t,[...e]}static async _setCapabilities(e){for(let t of e){if(!t.deviceId)continue;if(r===t.toJSON)continue;let e=n._mapDeviceInfo?.[t.deviceId];if(e)t.trackLabel=e.trackLabel,t.capabilities=e.capabilities;else try{const e=await navigator.mediaDevices.getUserMedia({video:{deviceId:t.deviceId},audio:!1}),i=e.getTracks().filter((e=>"video"===e.kind))[0];t.trackLabel=i.label,t.capabilities=i.getCapabilities?.(),e.getTracks().forEach((e=>e.stop()))}catch(e){console.warn("Failed to get `trackLabel` and `capabilities`, by opening camera.",e)}t.toJSON=r}}async open(){if("opened"!==this.status)if("closed"===this.status||"paused"===this.status)try{if("paused"===this.status&&this._cameraChangedWhenPaused&&(await this.close(),this._cameraChangedWhenPaused=!1),"closed"===this.status){let e;if(this._pOpen=new a,"string"==typeof this._requestedCamera){switch(this._requestedCamera){case"front":e={facingMode:"user"};break;case"quick-back":e={facingMode:"environment"};break;case"back":{const t=await n.getDeviceInfos();if(!t.length)throw Error("No camera found.");for(let i of n._cameraNameMatcher){for(let s of t){const t=(s.trackLabel||s.label)?.toLowerCase();for(let a of i)if(t.includes(a)){e={deviceId:s.deviceId};break}if(e)break}if(e)break}if(e)break;t.reverse();for(let i of t)if(i.capabilities?.facingMode?.includes("environment")){e={deviceId:i.deviceId};break}e={deviceId:t[0].deviceId};break}case"macro-back":{const t=await n.getDeviceInfos();if(!t.length)throw Error("No camera found.");const i=t.reduce(((e,t)=>t?.capabilities?.facingMode?.includes("environment")&&(!e||e?.capabilities?.focusDistance?.min||t?.capabilities?.focusDistance?.min<e?.capabilities?.focusDistance?.min)?t:e));e={deviceId:i?.deviceId||t[t.length-1].deviceId};break}default:throw Error(`Unknown camera preset: ${this._requestedCamera}`)}this._requestedCamera=e}else e=this._requestedCamera;const t={video:Object.assign({},e,this._requestedResolution),audio:!1},i=await navigator.mediaDevices.getUserMedia(t);if("closing"===this.status)throw Error("Camera closed.");if(this._video.srcObject=i,await this._video.play(),"closing"===this.status)throw Error("Camera closed.");this._pOpen.resolve();try{this._updateObjectFit()}catch(e){console.error(e)}try{this._updateCanvasSize()}catch(e){console.error(e)}}else{if(this._pOpen=new a,this.track.enabled=!0,await this._video.play(),"closing"===this.status)throw Error("Camera closed.");if(this._pOpen.resolve(),this._resolutionChangedWhenPaused){try{this._updateObjectFit()}catch(e){console.error(e)}try{this._updateCanvasSize()}catch(e){console.error(e)}this._resolutionChangedWhenPaused=!1}}this._callOpenedListeners()}catch(e){this.track?.stop(),this._video.srcObject=null;const t=this._pOpen;throw this._pOpen=null,this._shouldClose=!1,t.reject(),Error(`Error opening camera: ${e?.message}`,{cause:e})}else{if("opening"!==this.status&&"closing"!==this.status)throw Error("Never");await this._pOpen}}async pause(){try{await this._pOpen}catch(e){}"opened"===this.status&&(this.track.enabled=!1,this._video.pause())}async close(){if("closed"!==this.status)if("opening"===this.status&&(this._shouldClose=!0),"closing"!==this.status)this.track.stop(),this._video.srcObject=null,this._pOpen=null;else try{await this._pOpen}catch(e){}}async requestCamera(e){"string"==typeof e?h.includes(e)?this._requestedCamera=e:this._requestedCamera={deviceId:e}:e?"videoinput"===e.kind?e.deviceId?this._requestedCamera={deviceId:e.deviceId}:this._requestedCamera="back":this._requestedCamera=JSON.parse(JSON.stringify(e)):null===e?this._requestedCamera=null:void 0===e&&(this._requestedCamera="back"),"opened"===this.status?(await this.close(),await this.open()):"paused"===this.status&&(this._cameraChangedWhenPaused=!0)}async requestResolution(e,t){let i={};if("number"==typeof e?(i.width=e,"number"==typeof t&&(i.height=t)):Array.isArray(e)?(e[0]&&(i.width=e[0]),e[1]&&(i.height=e[1])):e?((e=JSON.parse(JSON.stringify(e))).width&&(i.width=e.width),e.height&&(i.height=e.height),e.aspectRatio&&(i.aspectRatio=e.aspectRatio)):null===e?i=null:void 0===e&&(i=o),this._requestedResolution=i,"opened"===this.status){await this.track.applyConstraints({...i});try{this._updateObjectFit()}catch(e){console.error(e)}try{this._updateCanvasSize()}catch(e){console.error(e)}this._callOpenedListeners()}else"paused"===this.status&&(this._resolutionChangedWhenPaused=!0,await this.track.applyConstraints({...i}))}async turnOnTorch(){if("opened"!==this.status)throw Error("Camera is not opened");await this.track.applyConstraints({advanced:[{torch:!0}]})}async turnOffTorch(){if("opened"!==this.status)throw Error("Camera is not opened");await this.track.applyConstraints({advanced:[{torch:!1}]})}getZoomRange(){if("opened"!==this.status)throw Error("Camera is not opened");return this.track.getCapabilities?.()?.zoom}async setZoom(e){if("opened"!==this.status)throw Error("Camera is not opened");await this.track.applyConstraints({advanced:[{zoom:e}]})}setSoftZoom(e,t){let{center:i,limit:s}=t||{},{x:a=0,y:o=0}=i||{};s&&e<1&&(e=1);let r=`scale(${e})`;if(i){if(s){const t=.5-.5/e;a<-t?a=-t:a>t&&(a=t),o<-t?o=-t:o>t&&(o=t)}r+=` translate(${a*=-100}%, ${o*=-100}%)`}this._softZoom={zoom:e,center:{x:a,y:o}},this._wrapperLv1.style.transform=r}getFrame(e){if("opened"!==this.status&&"paused"!==this.status)throw Error("Camera is not opened");let{x:t=0,y:i=0,width:s=this._video.videoWidth,height:a=this._video.videoHeight,reusedContext:o}=e||{};s=Math.round(s+t)-Math.round(t),a=Math.round(a+i)-Math.round(i),t=Math.round(t),i=Math.round(i);const r=o?.canvas||document.createElement("canvas");r.width!=s&&(r.width=s),r.height!=a&&(r.height=a);return(o||r.getContext("2d")).drawImage(this._video,t,i,s,a,0,0,s,a),r}setRegionBox(e){if(!(e=Object.assign(this._regionBox,e)).width||!e.height)return this._regionBoxWrapper?.remove(),this._regionBoxWrapper=null,this._regionBoxMask=null,void(this._regionBoxBorder=null);this._regionBoxWrapper||(this._regionBoxWrapper=document.createElement("div"),Object.assign(this._regionBoxWrapper.style,{width:"auto",height:"100%",maxWidth:"100%",maxHeight:"100%",minWidth:"100px",minHeight:"100px",aspectRatio:"1",flex:"none",position:"absolute",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}),this._regionBoxMask=document.createElement("div"),Object.assign(this._regionBoxMask.style,{width:"100%",height:"100%",flex:"none"}),this._regionBoxWrapper.append(this._regionBoxMask),this._regionBoxBorder=document.createElement("div"),Object.assign(this._regionBoxBorder.style,{flex:"none",boxSizing:"content-box",position:"absolute"}),this._regionBoxWrapper.append(this._regionBoxBorder),this._coreWrapper.append(this._regionBoxWrapper)),e.innerElement?e.innerElement.parentElement!==this._regionBoxBorder&&this._regionBoxBorder.append(e.innerElement):this._regionBoxBorder.innerHTML="";const t=100*e.center.y-50*e.height+50+"%",i=100*e.center.x+50*e.height+50+"%",s=100*e.center.y+50*e.width+50+"%",a=100*e.center.x-50*e.width+50+"%";Object.assign(this._regionBoxMask.style,{clipPath:`polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, ${a} ${t}, ${a} ${s}, ${i} ${s}, ${i} ${t}, ${a} ${t})`,...e.maskStyle}),Object.assign(this._regionBoxBorder.style,{width:100*e.width+"%",height:100*e.height+"%",...e.borderStyle}),this._updateObjectFit()}addCanvas(){const e=document.createElement("canvas");return Object.assign(e.style,{position:"absolute",left:0,top:0,width:"100%",height:"100%"}),"opened"!==this.status&&"paused"!==this.status||(e.width=this._video.videoWidth,e.height=this._video.videoHeight),this._video.parentElement.append(e),e}_updateCanvasSize(){if("opened"!==this.status&&"paused"!==this.status)return;const e=this._video;this._video.parentElement.querySelectorAll("canvas").forEach((t=>{t.width!==e.videoWidth&&(t.width=e.videoWidth),t.height!==e.videoHeight&&(t.height=e.videoHeight)}))}addEventListener(e,t){if("opened"!==e)throw Error("Unknown event type");this._openedListeners.add(t)}removeEventListener(e,t){if("opened"!==e)throw Error("Unknown event type");this._openedListeners.delete(t)}_callOpenedListeners(){try{this.onOpened?.(this)}catch(e){console.error(e)}this._openedListeners.forEach((e=>{try{e(this)}catch(e){console.error(e)}}))}videoXY2AbsoluteLT(e){const t=this._video,i=t.getBoundingClientRect(),s=getComputedStyle(document.body);if("static"===s.position){const s=document.documentElement.getBoundingClientRect();return e.map((e=>({left:e.x/t.videoWidth*i.width+i.x-s.x,top:e.y/t.videoHeight*i.height+i.y-s.y})))}{const a=document.body.getBoundingClientRect(),o=parseFloat(s.borderLeftWidth),r=parseFloat(s.borderTopWidth);return e.map((e=>({left:e.x/t.videoWidth*i.width+i.x-a.x-o,top:e.y/t.videoHeight*i.height+i.y-a.y-r})))}}videoXY2FixedLT(e){const t=this._video,i=t.getBoundingClientRect();return e.map((e=>({left:e.x/t.videoWidth*i.width+i.x,top:e.y/t.videoHeight*i.height+i.y})))}getVisibleAreaInVideoXY(e){let t;if(e&&this._regionBoxBorder){const e=this._regionBoxBorder.getBoundingClientRect();t={x:e.x,y:e.y,width:e.width,height:e.height};const i=getComputedStyle(this._regionBoxBorder),s=parseFloat(i.borderLeftWidth),a=parseFloat(i.borderTopWidth),o=parseFloat(i.borderRightWidth),r=parseFloat(i.borderBottomWidth);t.x+=s,t.y+=a,t.width-=s+o,t.height-=a+r}else{const e=this._coreWrapper.getBoundingClientRect();t={x:e.x,y:e.y,width:e.width,height:e.height}}const i=this._video.getBoundingClientRect(),s={x:(t.x-i.x)/i.width,y:(t.y-i.y)/i.height,width:t.width/i.width,height:t.height/i.height};s.x<0&&(s.width+=s.x,s.x=0),s.x>1&&(s.width-=s.x-1,s.x=1),s.y<0&&(s.height+=s.y,s.y=0),s.y>1&&(s.height-=s.y-1,s.y=1),s.x+s.width>1&&(s.width=1-s.x),s.x+s.width<0&&(s.width=-s.x),s.y+s.height>1&&(s.height=1-s.y),s.y+s.height<0&&(s.height=-s.y);const a=this._video.videoWidth,o=this._video.videoHeight;return{x:s.x*a,y:s.y*o,width:s.width*a,height:s.height*o}}}const h=["back","front","macro-back","quick-back"];e.Camera=n}));
